package fixtures

import (
	"fmt"
	"strings"
	"time"

	"github.com/a-h/templ"
)

type Item struct {
	ID          string
	Title       string
	Description *string
	Tags        []string
	Active      bool
	URL         string
}

func statusClass(active bool) string {
	if active {
		return "is-active"
	}
	return "is-inactive"
}

func stateClass(count int) string {
	switch {
	case count == 0:
		return "is-empty"
	case count > 7:
		return "is-busy"
	default:
		return "has-data"
	}
}

func uppercaseTags(tags []string) []string {
	result := make([]string, 0, len(tags))
	for _, tag := range tags {
		result = append(result, strings.ToUpper(tag))
	}
	return result
}

templ PageHeader(name string, count int) {
	<header class="page-header">
		<h1>Hello, { name }!</h1>
		<p>{ fmt.Sprintf("Tracking %d item(s).", count) }</p>
		<nav aria-label="Primary navigation">
			<ul class="menu">
				<li><a href="/items">Items</a></li>
				<li><a href="/reports">Reports</a></li>
				<li><a href="/settings">Settings</a></li>
			</ul>
		</nav>
	</header>
}

templ ItemList(items []Item) {
	<ul class="item-list">
		for index, item := range items {
			<li
				id={ fmt.Sprintf("item-%s", item.ID) }
				class={ "item", statusClass(item.Active) }
				if index != nil {
					data-index={ fmt.Sprintf("%d", index) }
				} else {
					data-index="unknown"
				}
			>
				<article class="card">
					<header>
						<h2>{ item.Title }</h2>
					</header>
					if item.Description != nil {
						<p>{ *item.Description }</p>
					}
					<a href={ item.URL } rel="noopener" target="_blank">
						View details
					</a>
					if len(item.Tags) > 0 {
						<ul class="tags">
							for _, tag := range uppercaseTags(item.Tags) {
								<li class="tag">{ tag }</li>
							}
						</ul>
					}
				</article>
			</li>
		}
	</ul>
}

templ KitchenSink(name string, items []Item, alerts <-chan string, footer templ.Component) {
	<!doctype html>
	<html lang="en">
		<head>
			<meta charset="utf-8"></meta>
			<meta content="width=device-width, initial-scale=1" name="viewport"></meta>
			<meta content="Fixture for kitchen sink templ lint coverage" name="description"></meta>
			<meta content="https://canonical-url.com" property="og:url"></meta>
			<meta content="video.movie" property="og:type"></meta>
			<meta content="title" property="og:title"></meta>
			<meta content="https://image.png" property="og:image"></meta>
			<title>Templ Kitchen Sink</title>
			<link href="/assets/css/base.css" rel="stylesheet"></link>
			<script defer src="/assets/js/htmx.min.js"></script>
		</head>
		<body class={ "kitchen-sink", stateClass(len(items)) } data-count={ fmt.Sprintf("%d", len(items)) }>
			@PageHeader(name, len(items))
			<main id="content">
				if len(items) == 0 {
					<section class="empty">
						<p>No items found yet.</p>
						<a href="/items/new">Create your first item</a>
					</section>
				} else {
					<section id="items" class="collection" hx-get="/items" hx-swap="outerHTML" hx-trigger="refresh">
						@ItemList(items)
					</section>
				}
				switch {
				case len(items) == 0:
					<p role="status">Waiting for the very first item.</p>
				default:
					<p role="status">{ fmt.Sprintf("%d total item(s).", len(items)) }</p>
				}
				<section aria-live="polite">
					@templ.Flush() {
						<div id="live_updates">
							for msg := range alerts {
								<output class="alert">{ msg }</output>
							}
						</div>
					}
				</section>
				{{ onChange := fmt.Sprintf("htmx.ajax('PUT', `/api/thing/%s/${this.value}/set-delay`, {swap: 'none'})", thing.Name) }}
				<label>
					Delay (seconds):
					<select
						onchange={ templ.ComponentScript{Call: onChange} }
					>
						<option selected?={ thing.Delay == 0 } value="0">0</option>
						<option selected?={ thing.Delay == 1 } value="1">1</option>
					</select>
				</label>
			</main>
			<footer role="contentinfo">
				@footer
				<small>Rendered at { time.Now().Format(time.RFC3339) }</small>
				@templ.Raw("<span class=\"legal\">Templ example</span>")
			</footer>
		</body>
	</html>
}
